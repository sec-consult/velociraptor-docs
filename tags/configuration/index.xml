<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Configuration on Velociraptor - Digging deeper!</title><link>https://docs.velociraptor.app/tags/configuration/</link><description>Recent content in Configuration on Velociraptor - Digging deeper!</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Sat, 28 Dec 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://docs.velociraptor.app/tags/configuration/index.xml" rel="self" type="application/rss+xml"/><item><title>How to set up OIDC authentication using Keycloak</title><link>https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/</link><pubDate>Sat, 28 Dec 2024 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/</guid><description>&lt;h1 id="how-to-set-up-oidc-authentication-using-keycloak">How to set up OIDC authentication using Keycloak&lt;/h1>
&lt;p>This guide walks you through the configuration of
&lt;a href="https://www.keycloak.org/" target="_blank" >Keycloak&lt;/a>
 as an OIDC authentication provider for
Velociraptor.&lt;/p>
&lt;p>Keycloak, as a self-hosted, free, and open source solution, may be an attractive
choice for Velociraptor deployments where using cloud-based and/or commercial
providers is not practical or possible. Most of the steps shown here would be
the same or similar for other self-hosted OIDC solutions (for example Zitadel or
Authentik), so it may be useful even if you are not using Keycloak.&lt;/p>

&lt;div class="mynotices warning">
 &lt;div heading=" Production deployment of Keycloak ">&lt;p>Keycloak is a Java application which can be installed manually or deployed via
several officially documented container-based methods. This guide partly mirrors Keycloak&amp;rsquo;s
&lt;a href="https://www.keycloak.org/getting-started/getting-started-docker" target="_blank" >Getting started guide&lt;/a>

which uses Docker to create a &lt;em>&amp;ldquo;development mode&amp;rdquo; instance&lt;/em> of Keycloak. This
method starts a working Keycloak instance but does not create a persistent
database or a production-ready secured server, since the goal here is only to
demonstrate the integration with Velociraptor.&lt;/p>
&lt;p>For production-ready deployment guidance we refer you to
&lt;a href="https://www.keycloak.org/server/configuration-production" target="_blank" >Configuring Keycloak for production&lt;/a>

and the official &lt;a href="https://www.keycloak.org/documentation" target="_blank" >Keycloak documentation&lt;/a>
.&lt;/p>
&lt;/div>
&lt;/div>


&lt;p>As mentioned above, the goal of this guide is to demonstrate a working SSO
configuration for Velociraptor using Keycloak. The basic steps and configuration
will be very similar or even identical for production deployments however some
of the steps shown here are deliberately over-simplified for reasons of brevity
and therefore do not reflect security best practices. Also Keycloak has a vast
array of options and capabilities, which we recommend you explore later, but the
intention here is to get up and running with a basic working integration since
it is better to start simple and be sure that it&amp;rsquo;s working as expected before
possibly adding complexity to it.&lt;/p>
&lt;p>In this simplified setup we have two hosts, with DNS names &lt;code>keycloak.local&lt;/code> and
&lt;code>velociraptor.local&lt;/code>. Substitute your DNS names where applicable. The two hosts
don&amp;rsquo;t need to be on the same network but the Velociraptor host needs to be able
to DNS-resolve the name of the Keycloak server and reach it on port 443. It&amp;rsquo;s
not necessary that the Keycloak server be able to resolve the Velociraptor
server&amp;rsquo;s DNS name but your server probably already has a DNS name already so
that clients can connect to it.&lt;/p>
&lt;p>




 
 

&lt;figure id="d1d61019841b4ed3a43cafc19e745e56">
 &lt;div data-featherlight="#d1d61019841b4ed3a43cafc19e745e56" class="figure">
 &lt;svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 658.5 380" width="658.5" height="380">
 &lt;!-- svg-source:excalidraw -->
 
 &lt;defs>
 
 
 &lt;/defs>
 &lt;g transform="translate(448.5 77.5) rotate(0 90 12.5)">&lt;text x="90" y="17.619999999999997" font-family="Excalifont, Xiaolai, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">velociraptor.local&lt;/text>&lt;/g>&lt;g stroke-linecap="round" transform="translate(428.5 50) rotate(0 110 40)">&lt;path d="M20 0 C88.57 -0.88, 160.01 -1.61, 200 0 M20 0 C58.54 -1.53, 98.43 -0.46, 200 0 M200 0 C211.69 1.33, 220.42 6.57, 220 20 M200 0 C211.6 0.43, 217.78 6.44, 220 20 M220 20 C220.28 32.33, 220.74 47.02, 220 60 M220 20 C220.42 29.27, 219.9 37.09, 220 60 M220 60 C219.25 73.02, 212.98 81.3, 200 80 M220 60 C219.38 74.64, 213.91 78.45, 200 80 M200 80 C158.64 82.64, 111.86 82.36, 20 80 M200 80 C129.17 77.64, 58.47 78.32, 20 80 M20 80 C7.8 79.81, -1.25 74.46, 0 60 M20 80 C4.42 78.88, 2.09 75.29, 0 60 M0 60 C-2.04 51.46, 0.64 37.8, 0 20 M0 60 C-0.59 44.56, 0.99 28.68, 0 20 M0 20 C-1.89 6, 5.69 0.76, 20 0 M0 20 C0.34 5.1, 7.14 -2.09, 20 0" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(18.5 77.5) rotate(0 101.5 12.5)">&lt;text x="101.49999999999999" y="17.619999999999997" font-family="Excalifont, Xiaolai, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">keycloak.local&lt;/text>&lt;/g>&lt;g stroke-linecap="round" transform="translate(10 50) rotate(0 110 40)">&lt;path d="M20 0 C76.96 -0.66, 132.14 -0.78, 200 0 M20 0 C62.04 0.37, 104.12 0.24, 200 0 M200 0 C213.23 1.37, 220.57 6.48, 220 20 M200 0 C213.56 2, 221.3 6.97, 220 20 M220 20 C221.55 28.63, 219.47 39.69, 220 60 M220 20 C219.3 31.71, 219.58 43.2, 220 60 M220 60 C219.26 74.79, 212.38 80.88, 200 80 M220 60 C218.17 75.49, 215.12 79.31, 200 80 M200 80 C131.97 80.13, 62.31 80.12, 20 80 M200 80 C130.24 82.46, 58.61 81.1, 20 80 M20 80 C6.8 81, -0.91 73.89, 0 60 M20 80 C6.95 81.88, 0.47 74.89, 0 60 M0 60 C-1.01 48.08, -1 40.08, 0 20 M0 60 C0.26 44.86, -0.6 30.27, 0 20 M0 20 C-1.4 7.51, 7.67 -0.6, 20 0 M0 20 C2.15 5.2, 5.79 0.48, 20 0" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round">&lt;g transform="translate(241.01502374283154 88.96543240222326) rotate(0 84.74741701882738 -0.9890726441210518)">&lt;path d="M-0.5 -0.03 C14.43 -0.16, 60.79 -1.83, 89.32 -1.98 C117.86 -2.12, 157.5 -1.02, 170.69 -0.9" stroke="#1e1e1e" stroke-width="2.5" fill="none" stroke-dasharray="8 10">&lt;/path>&lt;/g>&lt;g transform="translate(241.01502374283154 88.96543240222326) rotate(0 84.74741701882738 -0.9890726441210518)">&lt;path d="M22.77 -9.15 C17.92 -6.07, 8.15 -2.18, -0.5 -0.03" stroke="#1e1e1e" stroke-width="2.5" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(241.01502374283154 88.96543240222326) rotate(0 84.74741701882738 -0.9890726441210518)">&lt;path d="M23.19 7.95 C18.25 6.28, 8.36 5.41, -0.5 -0.03" stroke="#1e1e1e" stroke-width="2.5" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g stroke-linecap="round">&lt;g transform="translate(435.5 228) rotate(0 23 -40)">&lt;path d="M0.74 0.88 C4.55 -5.76, 15.38 -25.94, 22.89 -39.54 C30.41 -53.13, 41.87 -74.05, 45.84 -80.67 M-0.33 0.3 C3.31 -6.22, 14.34 -24.95, 21.89 -38.28 C29.45 -51.61, 40.75 -72.51, 44.99 -79.7" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(435.5 228) rotate(0 23 -40)">&lt;path d="M41.11 -56.52 C43.68 -63.72, 42.49 -70.81, 44.99 -79.7 M41.11 -56.52 C41.65 -62.21, 43.78 -68.79, 44.99 -79.7" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(435.5 228) rotate(0 23 -40)">&lt;path d="M27.11 -64.44 C33.94 -69.33, 36.97 -74.03, 44.99 -79.7 M27.11 -64.44 C31.13 -68.28, 36.67 -72.93, 44.99 -79.7" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g transform="translate(50 10) rotate(0 70 10)">&lt;text x="70" y="14.096" font-family="Excalifont, Xiaolai, Segoe UI Emoji" font-size="16px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">OIDC Provider&lt;/text>&lt;/g>&lt;g transform="translate(468.5 10) rotate(0 70 10)">&lt;text x="70" y="14.096" font-family="Excalifont, Xiaolai, Segoe UI Emoji" font-size="16px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">OIDC Client&lt;/text>&lt;/g>&lt;g stroke-linecap="round" transform="translate(345.6143342216468 250) rotate(0 63.941917866069446 38.268516949888806)">&lt;path d="M0 0 C50.92 -1.01, 99.18 0.86, 127.88 0 M0 0 C27.22 -0.35, 52.93 -1.09, 127.88 0 M127.88 0 C129 14.97, 127.16 33.27, 127.88 76.54 M127.88 0 C128.45 25.83, 128.67 51.78, 127.88 76.54 M127.88 76.54 C79.19 75.12, 34.34 75.28, 0 76.54 M127.88 76.54 C80.11 76.62, 32.38 76.24, 0 76.54 M0 76.54 C-0.1 48.8, -0.34 17.81, 0 0 M0 76.54 C1.01 56.33, 1.2 35.69, 0 0" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round">&lt;g transform="translate(344.5387364707516 260.71653439224417) rotate(0 64.42096614922218 0)">&lt;path d="M-1.04 -0.51 C20.56 -0.79, 107.14 -1.3, 128.92 -1.13 M0.62 -1.82 C22.13 -2.04, 106.57 -0.22, 128.02 -0.19" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g stroke-linecap="round" transform="translate(350.1023696906017 254.27156980000882) rotate(0 2.5009765625 2.5009765625)">&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="none" stroke-width="0" fill="#fa5252">&lt;/path>&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round" transform="translate(360.3650650031017 254.27156980000882) rotate(0 2.5009765625 2.5009765625)">&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="none" stroke-width="0" fill="#fab005">&lt;/path>&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round" transform="translate(371.07848146944787 254.722290953855) rotate(0 2.5009765625 2.5009765625)">&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="none" stroke-width="0" fill="#40c057">&lt;/path>&lt;path d="M5 2.5 C5 2.65, 4.99 2.79, 4.96 2.94 C4.94 3.08, 4.9 3.22, 4.85 3.36 C4.8 3.49, 4.74 3.63, 4.67 3.75 C4.59 3.88, 4.51 4, 4.42 4.11 C4.32 4.22, 4.22 4.32, 4.11 4.42 C4 4.51, 3.88 4.59, 3.75 4.67 C3.63 4.74, 3.49 4.8, 3.36 4.85 C3.22 4.9, 3.08 4.94, 2.94 4.96 C2.79 4.99, 2.65 5, 2.5 5 C2.36 5, 2.21 4.99, 2.07 4.96 C1.92 4.94, 1.78 4.9, 1.65 4.85 C1.51 4.8, 1.38 4.74, 1.25 4.67 C1.13 4.59, 1 4.51, 0.89 4.42 C0.78 4.32, 0.68 4.22, 0.59 4.11 C0.49 4, 0.41 3.88, 0.34 3.75 C0.26 3.63, 0.2 3.49, 0.15 3.36 C0.1 3.22, 0.06 3.08, 0.04 2.94 C0.01 2.79, 0 2.65, 0 2.5 C0 2.36, 0.01 2.21, 0.04 2.07 C0.06 1.92, 0.1 1.78, 0.15 1.65 C0.2 1.51, 0.26 1.38, 0.34 1.25 C0.41 1.13, 0.49 1, 0.59 0.89 C0.68 0.78, 0.78 0.68, 0.89 0.59 C1 0.49, 1.13 0.41, 1.25 0.34 C1.38 0.26, 1.51 0.2, 1.65 0.15 C1.78 0.1, 1.92 0.06, 2.07 0.04 C2.21 0.01, 2.36 0, 2.5 0 C2.65 0, 2.79 0.01, 2.94 0.04 C3.08 0.06, 3.22 0.1, 3.36 0.15 C3.49 0.2, 3.63 0.26, 3.75 0.34 C3.88 0.41, 4 0.49, 4.11 0.59 C4.22 0.68, 4.32 0.78, 4.42 0.89 C4.51 1, 4.59 1.13, 4.67 1.25 C4.74 1.38, 4.8 1.51, 4.85 1.65 C4.9 1.78, 4.94 1.92, 4.96 2.07 C4.99 2.21, 5 2.43, 5 2.5 C5.01 2.57, 5.01 2.43, 5 2.5" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-opacity="0.9" fill-opacity="0.9" stroke-linecap="round" transform="translate(387.1055424590751 270.77465983187085) rotate(0 21.360101269687846 21.360101269687846)">&lt;path d="M19.16 -0.23 C23.44 -1.03, 29.62 0.75, 33.42 3.45 C37.22 6.15, 40.81 11.46, 41.97 15.96 C43.12 20.46, 42.3 26.41, 40.34 30.46 C38.38 34.51, 34.21 38.33, 30.22 40.28 C26.22 42.23, 20.72 43.18, 16.4 42.14 C12.07 41.1, 7.03 37.79, 4.27 34.02 C1.5 30.24, -0.42 24.07, -0.18 19.48 C0.07 14.89, 2.27 9.7, 5.73 6.48 C9.19 3.26, 18.05 1.14, 20.59 0.19 C23.14 -0.76, 20.98 0.42, 21 0.77 M19.72 -0.31 C24.02 -0.97, 29.26 1.6, 32.88 4.19 C36.51 6.79, 40.03 10.88, 41.46 15.27 C42.89 19.66, 43.3 26.36, 41.48 30.54 C39.66 34.72, 34.8 38.49, 30.53 40.35 C26.26 42.21, 20.16 42.74, 15.87 41.72 C11.57 40.7, 7.29 38, 4.74 34.24 C2.2 30.48, 0.31 23.84, 0.57 19.18 C0.84 14.51, 3.35 9.39, 6.33 6.27 C9.32 3.14, 16.43 1.51, 18.5 0.43 C20.58 -0.65, 18.55 -0.61, 18.81 -0.19" stroke="none" stroke-width="0" fill="#04aaf7">&lt;/path>&lt;path d="M17.44 -0.08 C21.61 -1.26, 27.42 0.16, 31.42 2.48 C35.43 4.79, 39.73 9.51, 41.48 13.82 C43.22 18.13, 43.42 24, 41.89 28.34 C40.35 32.67, 36.27 37.43, 32.26 39.84 C28.25 42.26, 22.34 43.56, 17.8 42.83 C13.26 42.11, 8.01 39.07, 5 35.51 C1.99 31.94, -0.29 26.09, -0.27 21.45 C-0.25 16.81, 2.04 11.15, 5.1 7.65 C8.17 4.15, 15.94 1.62, 18.14 0.45 C20.34 -0.73, 18.29 0.28, 18.32 0.6 M21.61 -0.1 C25.95 -0.4, 32.14 1.83, 35.6 4.73 C39.06 7.63, 41.69 12.88, 42.36 17.32 C43.03 21.77, 41.79 27.33, 39.61 31.41 C37.43 35.5, 33.43 40.08, 29.3 41.85 C25.17 43.63, 19.18 43.76, 14.83 42.07 C10.49 40.38, 5.76 35.65, 3.25 31.7 C0.75 27.76, -0.83 22.88, -0.18 18.42 C0.47 13.95, 3.63 8.05, 7.15 4.91 C10.67 1.77, 18.65 0.43, 20.94 -0.42 C23.23 -1.27, 20.94 -0.71, 20.88 -0.19" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round">&lt;g transform="translate(414.1837065210507 286.9990118963285) rotate(0 -3.3114080732229922 5.9489359900645695)" fill-rule="evenodd">&lt;path d="M0 0 C-0.31 -0.07, -0.57 0.63, -1.83 -0.41 C-3.09 -1.46, -5.98 -5.62, -7.57 -6.27 C-9.16 -6.93, -10.52 -5.79, -11.36 -4.35 C-12.2 -2.91, -12.63 0.53, -12.61 2.37 C-12.6 4.22, -10.47 5.65, -11.27 6.74 C-12.07 7.83, -16.44 7.74, -17.42 8.89 C-18.41 10.04, -18.04 12.9, -17.2 13.64 C-16.36 14.39, -13.8 14.04, -12.38 13.35 C-10.96 12.66, -10.16 8.72, -8.7 9.48 C-7.24 10.23, -5 16.42, -3.62 17.87 C-2.24 19.32, -0.39 20.35, -0.42 18.17 C-0.44 15.99, -4.08 7.1, -3.78 4.8 C-3.48 2.5, 0.23 4.17, 1.39 4.35 C2.54 4.53, 1.85 5.61, 3.16 5.87 C4.47 6.12, 7.96 6.74, 9.24 5.87 C10.51 5, 11.64 1.43, 10.8 0.63 C9.97 -0.16, 5.11 2.18, 4.22 1.11 C3.34 0.04, 5.78 -4.68, 5.49 -5.76 C5.19 -6.84, 3.43 -6.15, 2.47 -5.35 C1.52 -4.54, 0.17 -1.81, -0.24 -0.92 C-0.65 -0.03, -0.04 -0.15, 0 0" stroke="none" stroke-width="0" fill="#40c057" fill-rule="evenodd">&lt;/path>&lt;path d="M0 0 C-0.31 -0.07, -0.57 0.63, -1.83 -0.41 C-3.09 -1.46, -5.98 -5.62, -7.57 -6.27 C-9.16 -6.93, -10.52 -5.79, -11.36 -4.35 C-12.2 -2.91, -12.63 0.53, -12.61 2.37 C-12.6 4.22, -10.47 5.65, -11.27 6.74 C-12.07 7.83, -16.44 7.74, -17.42 8.89 C-18.41 10.04, -18.04 12.9, -17.2 13.64 C-16.36 14.39, -13.8 14.04, -12.38 13.35 C-10.96 12.66, -10.16 8.72, -8.7 9.48 C-7.24 10.23, -5 16.42, -3.62 17.87 C-2.24 19.32, -0.39 20.35, -0.42 18.17 C-0.44 15.99, -4.08 7.1, -3.78 4.8 C-3.48 2.5, 0.23 4.17, 1.39 4.35 C2.54 4.53, 1.85 5.61, 3.16 5.87 C4.47 6.12, 7.96 6.74, 9.24 5.87 C10.51 5, 11.64 1.43, 10.8 0.63 C9.97 -0.16, 5.11 2.18, 4.22 1.11 C3.34 0.04, 5.78 -4.68, 5.49 -5.76 C5.19 -6.84, 3.43 -6.15, 2.47 -5.35 C1.52 -4.54, 0.17 -1.81, -0.24 -0.92 C-0.65 -0.03, -0.04 -0.15, 0 0 M0 0 C-0.31 -0.07, -0.57 0.63, -1.83 -0.41 C-3.09 -1.46, -5.98 -5.62, -7.57 -6.27 C-9.16 -6.93, -10.52 -5.79, -11.36 -4.35 C-12.2 -2.91, -12.63 0.53, -12.61 2.37 C-12.6 4.22, -10.47 5.65, -11.27 6.74 C-12.07 7.83, -16.44 7.74, -17.42 8.89 C-18.41 10.04, -18.04 12.9, -17.2 13.64 C-16.36 14.39, -13.8 14.04, -12.38 13.35 C-10.96 12.66, -10.16 8.72, -8.7 9.48 C-7.24 10.23, -5 16.42, -3.62 17.87 C-2.24 19.32, -0.39 20.35, -0.42 18.17 C-0.44 15.99, -4.08 7.1, -3.78 4.8 C-3.48 2.5, 0.23 4.17, 1.39 4.35 C2.54 4.53, 1.85 5.61, 3.16 5.87 C4.47 6.12, 7.96 6.74, 9.24 5.87 C10.51 5, 11.64 1.43, 10.8 0.63 C9.97 -0.16, 5.11 2.18, 4.22 1.11 C3.34 0.04, 5.78 -4.68, 5.49 -5.76 C5.19 -6.84, 3.43 -6.15, 2.47 -5.35 C1.52 -4.54, 0.17 -1.81, -0.24 -0.92 C-0.65 -0.03, -0.04 -0.15, 0 0" stroke="#087f5b" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g stroke-linecap="round">&lt;g stroke-opacity="0.9" fill-opacity="0.9" transform="translate(388.1646049331026 291.73753339505186) rotate(0 21.047557886136133 0)">&lt;path d="M0.26 0.28 C7.26 0.24, 34.61 -0.21, 41.55 -0.22 M-0.27 -0.05 C6.92 -0.02, 35.55 0.47, 42.51 0.36" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g stroke-linecap="round">&lt;g stroke-opacity="0.9" fill-opacity="0.9" transform="translate(393.25993396287697 276.30300446808565) rotate(0 14.659303301924297 2.593116626464507)">&lt;path d="M0 0 C0.13 0.38, 0.09 1.58, 0.77 2.28 C1.46 2.97, 2.81 3.68, 4.1 4.19 C5.4 4.7, 6.64 5.13, 8.54 5.34 C10.43 5.55, 12.97 5.55, 15.48 5.45 C17.99 5.34, 21.44 5.28, 23.58 4.71 C25.72 4.14, 27.36 2.86, 28.32 2.03 C29.27 1.2, 29.15 0.12, 29.32 -0.26 M0 0 C0.13 0.38, 0.09 1.58, 0.77 2.28 C1.46 2.97, 2.81 3.68, 4.1 4.19 C5.4 4.7, 6.64 5.13, 8.54 5.34 C10.43 5.55, 12.97 5.55, 15.48 5.45 C17.99 5.34, 21.44 5.28, 23.58 4.71 C25.72 4.14, 27.36 2.86, 28.32 2.03 C29.27 1.2, 29.15 0.12, 29.32 -0.26" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g stroke-opacity="0.9" fill-opacity="0.9" stroke-linecap="round" transform="translate(401.33384988679643 269.39213020227817) rotate(0 7.764217176558077 22.41115194065469)">&lt;path d="M8.39 0.35 C9.87 0.59, 11.9 3.79, 13.03 7.22 C14.17 10.64, 15.08 16.25, 15.2 20.92 C15.33 25.58, 14.63 31.39, 13.77 35.21 C12.91 39.03, 11.55 42.57, 10.05 43.81 C8.54 45.06, 6.3 44.75, 4.72 42.69 C3.14 40.63, 1.27 35.9, 0.56 31.48 C-0.14 27.06, 0 20.7, 0.48 16.16 C0.96 11.63, 2.03 6.85, 3.42 4.24 C4.8 1.63, 7.85 0.99, 8.8 0.49 C9.76 0, 9.17 0.92, 9.14 1.25 M7.74 0.52 C9.47 0.1, 11.68 2.21, 13 4.88 C14.31 7.55, 15.42 11.88, 15.63 16.55 C15.84 21.22, 15.11 28.52, 14.26 32.89 C13.41 37.25, 12.02 40.95, 10.54 42.72 C9.05 44.5, 6.92 44.94, 5.33 43.54 C3.73 42.14, 1.95 38.14, 0.97 34.33 C-0.01 30.51, -0.9 25.34, -0.57 20.65 C-0.25 15.96, 1.66 9.57, 2.91 6.19 C4.16 2.8, 6.12 1.3, 6.92 0.33 C7.73 -0.63, 7.77 0.08, 7.75 0.42" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;g stroke-linecap="round">&lt;g stroke-opacity="0.9" fill-opacity="0.9" transform="translate(394.77588547250286 308.04009652652667) rotate(0 14.659303301924297 -2.677051221420811)">&lt;path d="M0 0 C0.68 -0.72, 2.68 -3.4, 4.1 -4.32 C5.53 -5.24, 6.64 -5.3, 8.54 -5.52 C10.43 -5.73, 12.97 -5.73, 15.48 -5.63 C17.99 -5.52, 21.44 -5.45, 23.58 -4.86 C25.72 -4.28, 27.36 -2.95, 28.32 -2.1 C29.27 -1.24, 29.15 -0.12, 29.32 0.27 M0 0 C0.68 -0.72, 2.68 -3.4, 4.1 -4.32 C5.53 -5.24, 6.64 -5.3, 8.54 -5.52 C10.43 -5.73, 12.97 -5.73, 15.48 -5.63 C17.99 -5.52, 21.44 -5.45, 23.58 -4.86 C25.72 -4.28, 27.36 -2.95, 28.32 -2.1 C29.27 -1.24, 29.15 -0.12, 29.32 0.27" stroke="#000000" stroke-width="1" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;g transform="translate(308.5 350) rotate(0 100 10)">&lt;text x="100" y="14.096" font-family="Excalifont, Xiaolai, Segoe UI Emoji" font-size="16px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">end user (web browser)&lt;/text>&lt;/g>&lt;g stroke-linecap="round">&lt;g transform="translate(236.5 132) rotate(0 56 48)">&lt;path d="M0.23 -1.01 C9.89 5.93, 40.46 26.13, 58.92 42.27 C77.38 58.41, 102.01 86.73, 110.98 95.83 M-1.1 1.07 C8.83 8.1, 41.99 27.42, 61.07 43.42 C80.14 59.42, 104.62 88.51, 113.34 97.06" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(236.5 132) rotate(0 56 48)">&lt;path d="M24.35 5.59 C13.47 1.34, 4.77 -1.07, 0.23 -1.01 M24.35 5.59 C18.41 3.55, 10.57 1.16, 0.23 -1.01" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;g transform="translate(236.5 132) rotate(0 56 48)">&lt;path d="M14.46 19.55 C7.26 9.97, 2.32 2.27, 0.23 -1.01 M14.46 19.55 C11.26 13.45, 6.25 7.06, 0.23 -1.01" stroke="#1e1e1e" stroke-width="2" fill="none">&lt;/path>&lt;/g>&lt;/g>&lt;mask>&lt;/mask>&lt;/svg>
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="network_overview.svg">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Network overview
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>The high-level steps of this setup process are:&lt;/p>
&lt;ol>
&lt;li>Create a self-hosted Docker-based Keycloak instance.&lt;/li>
&lt;li>Configure an authentication realm, OIDC client and test users in Keycloak.&lt;/li>
&lt;li>Configure the authentication provider in Velociraptor.&lt;/li>
&lt;li>Add test users to Velociraptor.&lt;/li>
&lt;li>Test the authentication process.&lt;/li>
&lt;/ol>
&lt;h2 id="create-a-docker-based-keycloak-instance">Create a Docker-based Keycloak instance&lt;/h2>
&lt;p>We assume that Docker has already been installed and configured on the
designated Keycloak host. We aren&amp;rsquo;t going to use Docker Compose but for
production deployment you might prefer to do so, and example configurations can
be found on the internet.&lt;/p>
&lt;p>Before we install Keycloak we are going to need a certificate for it to use. Here
we will generate a simple self-signed cert with corresponding private key but ideally in
production you would have a cert signed by a trusted CA.&lt;/p>
&lt;p>&lt;strong>1. Generate a key pair&lt;/strong>&lt;/p>
&lt;pre>&lt;code class="language-sh"># Create keycloak-server.crt.pem and keycloak-server.key.pem
openssl req -newkey rsa:2048 -nodes -subj &amp;quot;/CN=keycloak.local&amp;quot; \
-addext &amp;quot;subjectAltName=DNS:keycloak.local,IP:192.168.56.1&amp;quot; \
-keyout keycloak-server.key.pem -x509 -days 3650 -out keycloak-server.crt.pem
# Set appropriate permissions on files
chmod -R 644 keycloak-server*
&lt;/code>&lt;/pre>
&lt;p>NOTE: The certificate SAN is required by Velociraptor. If not present you will receive
this error when trying to start Velociraptor.&lt;br>
&lt;code>error: gui: starting frontend: Get &amp;quot;https://keycloak.local/.well-known/openid-configuration&amp;quot;: x509: certificate relies on legacy Common Name field, use SANs instead&lt;/code>&lt;br>
Putting the IP in the SAN is not really necessary but helpful if you need to
connect to Keycloak&amp;rsquo;s admin page using it&amp;rsquo;s IP.&lt;/p>
&lt;p>Now that we have the key pair we can run Docker which will pull the latest
Keycloak image (26.0.7 at the time of writing).&lt;/p>
&lt;p>&lt;strong>2. Run the Docker command.&lt;/strong>&lt;/p>
&lt;pre>&lt;code class="language-sh">docker run -p 443:443 -e KC_HOSTNAME=keycloak.local \
-e KC_BOOTSTRAP_ADMIN_USERNAME=admin -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
-v /root/keycloak-server.crt.pem:/etc/x509/https/keycloak-server.crt.pem \
-v /root/keycloak-server.key.pem:/etc/x509/https/keycloak-server.key.pem \
-e KC_HTTPS_CERTIFICATE_FILE=/etc/x509/https/keycloak-server.crt.pem \
-e KC_HTTPS_CERTIFICATE_KEY_FILE=/etc/x509/https/keycloak-server.key.pem \
quay.io/keycloak/keycloak:latest start-dev --https-port=443
&lt;/code>&lt;/pre>
&lt;p>We set various Keycloak config options as Docker environment variables and
make the cert and private key available inside the Docker using volume mapping.&lt;/p>
&lt;p>If the Docker fails to start, you should inspect the command output for errors.
If successful it should report
&lt;code>Listening on: http://0.0.0.0:8080 and https://0.0.0.0:443&lt;/code>.&lt;/p>
&lt;p>The KC_BOOTSTRAP* variables create an initial user &lt;code>admin&lt;/code> with password
&lt;code>admin&lt;/code> which we use to configure Keycloak in the next section.&lt;/p>
&lt;h2 id="configure-keycloak">Configure Keycloak&lt;/h2>
&lt;p>Next we go through the steps that are almost the same as described in Keycloak&amp;rsquo;s
&lt;a href="https://www.keycloak.org/getting-started/getting-started-docker" target="_blank" >Getting started guide&lt;/a>
.&lt;/p>
&lt;p>Connect to Keycloak&amp;rsquo;s Admin Console (in this case: &lt;a href="https://keycloak.local" target="_blank" >https://keycloak.local&lt;/a>
) and
log in with the &lt;code>admin&lt;/code> user.&lt;/p>
&lt;p>&lt;strong>3. Create an authentication realm&lt;/strong>&lt;/p>
&lt;p>





&lt;figure id="a95eb8c08fa648913b9893b649864bc1">
 &lt;div data-featherlight="#a95eb8c08fa648913b9893b649864bc1" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak00.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak00.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>You can use any name for the realm but here we are going to just use &lt;code>myrealm&lt;/code>
for convenience.&lt;/p>
&lt;p>





&lt;figure id="53dcd412a99f4cf293824a7b329e2c3f">
 &lt;div data-featherlight="#53dcd412a99f4cf293824a7b329e2c3f" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak01.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak01.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>Click &lt;strong>Create&lt;/strong>.&lt;/p>
&lt;p>&lt;strong>4. Create OIDC client configuration for Velociraptor&lt;/strong>&lt;/p>
&lt;p>In this step we create a new client record and client secret which we will use
later in the Velociraptor configuration. In the realm selection drop-down ensure
that you are in the new &lt;code>myrealm&lt;/code> realm.&lt;/p>
&lt;p>In the sidebar select &lt;strong>Clients&lt;/strong> and then select &lt;strong>Create client&lt;/strong>.&lt;/p>
&lt;p>





&lt;figure id="b765549e2d38410bcea9c79f931c3c84">
 &lt;div data-featherlight="#b765549e2d38410bcea9c79f931c3c84" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak02.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak02.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>This will start a 3-page configuration wizard. On the first page the &lt;strong>Client
ID&lt;/strong> is all that&amp;rsquo;s required. Enter &lt;code>velociraptor&lt;/code> and click &lt;strong>Next&lt;/strong>.&lt;/p>
&lt;p>





&lt;figure id="79217a623d69f8f8d2136f7b6f875fc7">
 &lt;div data-featherlight="#79217a623d69f8f8d2136f7b6f875fc7" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak03.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak03.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>On the second page, choose &lt;strong>Client authentication: ON&lt;/strong> and
&lt;strong>Authentication flow: Standard flow&lt;/strong> (only). Then click &lt;strong>Next&lt;/strong>.&lt;/p>
&lt;p>





&lt;figure id="0f8adf194ac2d23ee44bde03f971a5b8">
 &lt;div data-featherlight="#0f8adf194ac2d23ee44bde03f971a5b8" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak04.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak04.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>On the third page we use the following values (adapt to your DNS names if your
are replicating the setup in your own environment):&lt;/p>
&lt;ul>
&lt;li>Valid redirect URIs: &lt;code>https://velociraptor.local:8889/auth/oidc/keycloak/callback&lt;/code>&lt;/li>
&lt;li>Valid post logout redirect URIs:
&lt;code>https://velociraptor.local:8889/app/logoff.html&lt;/code>&lt;/li>
&lt;li>Web origins: &lt;code>https://velociraptor.local&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>





&lt;figure id="680a948778124e0b21e6b194ef5b310a">
 &lt;div data-featherlight="#680a948778124e0b21e6b194ef5b310a" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak05.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak05.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>Then click &lt;strong>Save&lt;/strong>. Your OIDC client configuration is now created.&lt;/p>
&lt;p>On the page that follows, go to the &lt;strong>Credentials&lt;/strong> tab. There you will find the
&lt;strong>Client secret&lt;/strong> which you will need for your Velociraptor configuration. It is
randomly generated and you can regenerate it if desired, but if you do so then
don&amp;rsquo;t forget to update your Velociraptor server&amp;rsquo;s config with the new secret.
Typically you would only regenerate it if you suspected a compromised secret.&lt;/p>
&lt;p>





&lt;figure id="c028e0441ef62c53cd66ed4eb371c2bd">
 &lt;div data-featherlight="#c028e0441ef62c53cd66ed4eb371c2bd" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak06.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak06.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>The next action is to configure email addresses as login usernames. To do that
navigate via the sidebar to &lt;strong>Realm settings&lt;/strong> &amp;gt; &lt;strong>Login&lt;/strong> tab. Ensure that
&lt;strong>Email as username&lt;/strong> and &lt;strong>Login with email&lt;/strong> are enabled. The additional user
preferences shown in the following screenshot are optional and in your case
would be determined by your organizational policies.&lt;/p>
&lt;p>





&lt;figure id="688b70e233f7b149f02f81f39ecb073a">
 &lt;div data-featherlight="#688b70e233f7b149f02f81f39ecb073a" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak08.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak08.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>The last action in this step is to configure the required actions for
authentication so that users don&amp;rsquo;t have to enter additional information when
they first log in.
Navigate via the sidebar to &lt;strong>Authentication&lt;/strong> &amp;gt; &lt;strong>Required actions&lt;/strong> tab.
Disable all options except &lt;strong>Update password&lt;/strong>.&lt;/p>
&lt;p>&lt;strong>5. Create test users&lt;/strong>&lt;/p>
&lt;p>We will need at least one user account to test the authentication. From the
sidebar select &lt;strong>Users&lt;/strong> and then click the &lt;strong>Create new user&lt;/strong> button.&lt;/p>
&lt;p>





&lt;figure id="f75abd5fd7309f3da9986f814ab200a5">
 &lt;div data-featherlight="#f75abd5fd7309f3da9986f814ab200a5" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak07.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak07.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>For the user account I am going to create one named &lt;code>bob@local&lt;/code>. Remember that
we previously enabled &lt;strong>Email as username&lt;/strong> and &lt;strong>Login with email&lt;/strong>, so all
other fields are optional. I also selected &lt;strong>Email verified&lt;/strong> to avoid an email
verification step when logging in.&lt;/p>
&lt;p>





&lt;figure id="cb7b6a63eddd5ea217e2a8190ea68bd7">
 &lt;div data-featherlight="#cb7b6a63eddd5ea217e2a8190ea68bd7" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak09.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak09.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>After creating the account, go to the Credentials tab and set a password. Note
that we leave &lt;strong>Temporary:ON&lt;/strong> set so that the password must be changed on first
logon. Note also that this is a simplified demonstration so for that reason
we&amp;rsquo;re ONLY using password auth while Keycloak easily supports multi-factor
authentication.&lt;/p>
&lt;p>





&lt;figure id="d0e5f2107f59ca1869103d86263ad441">
 &lt;div data-featherlight="#d0e5f2107f59ca1869103d86263ad441" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak10.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak10.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>Repeat the user creation actions to also create a user account
&lt;code>fred@local&lt;/code>.&lt;/p>
&lt;p>





&lt;figure id="2e597f774790a1692072c8401de23a6c">
 &lt;div data-featherlight="#2e597f774790a1692072c8401de23a6c" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/keycloak11.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="keycloak11.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>Now we are ready to move to configuring the Velociraptor side of things.&lt;/p>
&lt;h2 id="configure-velociraptor">Configure Velociraptor&lt;/h2>

&lt;div class="mynotices tip">
 &lt;div heading="tip">&lt;p>While configuring, testing and potentially troubleshooting problems, it&amp;rsquo;s
easier if you can see Velociraptor&amp;rsquo;s log messages. You can stop the server
service and then run the server manually on the command line by using the
following commands:&lt;/p>
&lt;pre>&lt;code class="language-bash">sudo systemctl stop velociraptor_server
sudo -u velociraptor bash
velociraptor -c /etc/velociraptor/server.config.yaml frontend -v
&lt;/code>&lt;/pre>
&lt;p>This will display the log messages in the terminal.&lt;/p>
&lt;/div>
&lt;/div>


&lt;p>&lt;strong>6. Add the authenticator settings to your Velciraptor config&lt;/strong>&lt;/p>
&lt;p>In the &lt;code>GUI&lt;/code> section of your Velociraptor config you should have the following
authenticator settings by default:&lt;/p>
&lt;pre>&lt;code class="language-yaml"> authenticator:
 type: Basic
&lt;/code>&lt;/pre>
&lt;p>We no longer want Basic auth and instead want SSO, so replace that with these
new settings to match our Keycloak configuration:&lt;/p>
&lt;pre>&lt;code class="language-yaml"> type: oidc
 oidc_issuer: https://keycloak.local/realms/myrealm
 oidc_name: keycloak
 avatar: https://www.keycloak.org/resources/images/logo.svg
 oauth_client_id: velociraptor
 oauth_client_secret: p4EABoniopnasbrmstDnsHrQcSukNmp2
&lt;/code>&lt;/pre>
&lt;p>The &lt;code>oauth_client_secret&lt;/code> is the value we obtained at the end of step 4. The
&lt;code>oauth_client_id&lt;/code> is the name we used for the OIDC Client ID in that same
section.&lt;/p>
&lt;p>The &lt;code>oidc_name&lt;/code> can be anything you want but it must exactly match
(case-sensitive) the substring used in the &lt;strong>Valid redirect URIs&lt;/strong> field of the
client configuration in Keycloak.&lt;/p>
&lt;p>Keycloak requires that the &lt;code>oidc_issuer&lt;/code> field specify the path
&lt;code>/realms/myrealm&lt;/code> as this is where is serves the OpenID Endpoint Configuration
that Velociraptor will need to access. If you have somehow gotten this wrong
then Velociraptor will log an error such as:
&lt;code>[ERROR] can not get information from OIDC provider, check https://keycloak.local/.well-known/openid-configuration is correct and accessible from the server.&lt;/code>&lt;/p>
&lt;p>Before you start Velociraptor, if you are using a self-signed cert for Keycloak
then also attend to the next step.&lt;/p>
&lt;p>&lt;strong>7. Copy the Keycloak server cert to the trusted root store.&lt;/strong>&lt;/p>
&lt;p>Because the Keycloak server is using a certificate that wasn&amp;rsquo;t issued by a
trusted CA, we need to add it&amp;rsquo;s certificate to the trusted root store on the
Velociraptor server. Assuming your server is Ubuntu or similar this means saving
a copy of the certificate to &lt;code>/etc/ssl/certs&lt;/code>.&lt;/p>
&lt;p>Without this step you will see this error in the log when attempting to start
Velociraptor:
&lt;code>error: gui: starting frontend: Get &amp;quot;https://keycloak.local/...&amp;quot;: x509: certificate signed by unknown authority (possibly because of &amp;quot;crypto/rsa: verification error&amp;quot; while trying to verify candidate authority certificate &amp;quot;keycloak.local&amp;quot;)&lt;/code>&lt;/p>
&lt;p>&lt;strong>8. Start Velociraptor&lt;/strong>&lt;/p>
&lt;p>The server should now start cleanly and continue running. In the log messages
you should see &lt;code>GUI will use the oidc authenticator&lt;/code>. That means everything is
OK with the authenticator config.&lt;/p>
&lt;p>One possible gotcha is if the server&amp;rsquo;s &lt;code>GUI.public_url&lt;/code> setting is still using
an IP address or if &lt;code>GUI.bind_address&lt;/code> is not set to &lt;code>0.0.0.0&lt;/code> then you may get
stopped with the error:
&lt;code>error: gui: starting frontend: Authentication type 'oidc' requires valid public_url parameter&lt;/code>&lt;/p>
&lt;p>In this case the &lt;code>GUI.public_url&lt;/code> is set to &lt;code>https://velociraptor.local:8889/&lt;/code>.&lt;/p>
&lt;h2 id="add-test-users">Add test users&lt;/h2>
&lt;p>We have created 2 users in Keycloak but these users don&amp;rsquo;t yet exist in
Velociraptor. Velociraptor has it&amp;rsquo;s own permissions model and therefore needs to
know about any users so that once they authenticate the correct permissions can
be applied.&lt;/p>
&lt;p>Users can be created using VQL in Velociraptor notebooks but since we have now
switched authentication providers we no longer have access to the GUI. Of course
we could have added the users before we switched but let&amp;rsquo;s pretend we didn&amp;rsquo;t and
instead do it from the command line.&lt;/p>
&lt;p>We will make &lt;code>bob@local&lt;/code> a server admin and grant &lt;code>fred@local&lt;/code> the &amp;ldquo;reader&amp;rdquo;
role, which provides minimal access to Velociraptor&amp;rsquo;s GUI. The following two
commands will create these users:&lt;/p>
&lt;p>&lt;strong>9. Add users to the datastore&lt;/strong>&lt;/p>
&lt;pre>&lt;code class="language-sh">velociraptor --config server.config.yaml user add --role administrator bob@local
velociraptor --config server.config.yaml user add --role reader fred@local
&lt;/code>&lt;/pre>
&lt;p>NOTE: We provide the &lt;code>--config&lt;/code> flag so that this invocation of the velociraptor
binary knows which datastore to add the new users to. This can be done while the
server service is running or not running, but either way the service will need
to be restarted to update itself with the datastore changes.&lt;/p>
&lt;p>Because of our OIDC authenticator config, when adding each user we will receive
an acknowledgement message saying
&lt;code>&amp;quot;Authentication will occur via oidc - therefore no password needs to be set.&amp;quot;&lt;/code>&lt;/p>
&lt;h2 id="test-authentication-process">Test authentication process&lt;/h2>
&lt;p>Test the authentication process by going to &lt;code>https://velociraptor.local:8889/&lt;/code>&lt;/p>
&lt;p>You will be presented with the choice to log in with Keycloak (multiple
authentication providers are supported but we only have one configured).&lt;/p>
&lt;p>





&lt;figure id="31e5adca94cd8097aa53d3d80b854494">
 &lt;div data-featherlight="#31e5adca94cd8097aa53d3d80b854494" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth00.png" alt="">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth00.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>Enter initial credentials (password that was set in Keycloak).&lt;/p>
&lt;p>





&lt;figure id="cdf9c2bc39d8b9246798ea0c93a41a77">
 &lt;div data-featherlight="#cdf9c2bc39d8b9246798ea0c93a41a77" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth01.png" alt="Login page">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth01.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Login page
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>You will be required to change the password because we configured
&lt;strong>Temporary:ON&lt;/strong> when setting the account&amp;rsquo;s password.&lt;/p>
&lt;p>





&lt;figure id="2aa22cd981916f37b088880464064e88">
 &lt;div data-featherlight="#2aa22cd981916f37b088880464064e88" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth02.png" alt="Change the password">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth02.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Change the password
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>





&lt;figure id="8a64b7f7025e7880b3bf2e942eb4a6b9">
 &lt;div data-featherlight="#8a64b7f7025e7880b3bf2e942eb4a6b9" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth03.png" alt="Successful login!">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth03.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Successful login!
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>





&lt;figure id="a8eb9d50ba9e3b752201affb797b7391">
 &lt;div data-featherlight="#a8eb9d50ba9e3b752201affb797b7391" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth04.png" alt="We can verify that the user has the server admin role.">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth04.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 We can verify that the user has the server admin role.
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>





&lt;figure id="e6be4f3b4580ccf759ee6011572ac2d7">
 &lt;div data-featherlight="#e6be4f3b4580ccf759ee6011572ac2d7" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/setup_keycloak/auth05.png" alt="We can sign out and sign in again.">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="auth05.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 We can sign out and sign in again.
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>The same process applies to &lt;code>fred@local&lt;/code> except that we can verify in
Velociraptor that the user has the read-only role.&lt;/p>

&lt;div class="mynotices tip">
 &lt;div heading="tip">&lt;p>For testing multiple users in the same web browser you may have trouble
fully logging a user out because while logged out of Velociraptor the OIDC
session is still active.&lt;/p>
&lt;p>Logout of the OIDC session can be achieved by
navigating to the the endpoint
&lt;code>https://keycloak.local/realms/myrealm/protocol/openid-connect/logout&lt;/code>
from within the same web browser and choosing to log out.&lt;/p>
&lt;/div>
&lt;/div>


&lt;h2 id="what-next">What next?&lt;/h2>
&lt;p>Once you have the working authentication setup, as per this guide, then you can
begin experimenting with additional options while knowing that any change which
causes a negative effect can be reverted back to a known working state. This is
a much easier approach than diving in with a complex configuration and spending
hours troubleshooting why it doesn&amp;rsquo;t work.&lt;/p>
&lt;p>Since the Docker installation used in the guide is non-permanent it will reset
when you restart the docker VM. For testing and experimenting that&amp;rsquo;s a good
thing as you gain familiarity by going through the process. As mentioned,
Keycloak supports multifactor authentication, complex authentication flow
options, themeable login screens, and many other cool features. However for
permanent configuration you will need to learn how to create a persistent
Keycloak database, possibly using a different deployment method.&lt;/p></description></item><item><title>How to manage storage space on the server</title><link>https://docs.velociraptor.app/knowledge_base/tips/deleting_old_data/</link><pubDate>Fri, 19 Jul 2024 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/deleting_old_data/</guid><description>&lt;h1 id="how-to-manage-storage-space-on-the-server">How to manage storage space on the server&lt;/h1>
&lt;p>Velociraptor can collect a lot of data quickly but usually the data is
only relevant for short periods of time.&lt;/p>
&lt;p>Disk space management is an important part of Velociraptor
administrators tasks. You can keep an eye on the disk utilization as
shown on the dashboard.&lt;/p>
&lt;p>If you need to grow the disk during an investigation, and you are
using a cloud VM from Amazon with Elastic Block Storage (EBS), disk
space management is very easy. In the AWS cloud it is possible to
resize disk space dynamically. See &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html" target="_blank" >Requesting
Modifications&lt;/a>

to Your EBS Volumes and &lt;a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html" target="_blank" >Extending a Linux File System After
Resizing&lt;/a>

a Volume. You can do this without even restarting the server.&lt;/p>
&lt;p>If you must attach a new volume you can migrate data from the old
datastore directory (as specified in the config file) to the new
directory by simply copying all the files. You must ensure permissions
remain the same (typically files are owned by the &lt;code>velociraptor&lt;/code> low
privilege local linux account).&lt;/p>
&lt;p>It is also possible to start with an empty datastore directory and
only copy selected files:&lt;/p>
&lt;ol>
&lt;li>The &lt;code>users&lt;/code> directory contains user accounts (hashed password etc)&lt;/li>
&lt;li>The &lt;code>acl&lt;/code> directory contains user ACLs&lt;/li>
&lt;li>The &lt;code>artifact_definitions&lt;/code> contains custom artifacts&lt;/li>
&lt;li>The &lt;code>config&lt;/code> directory contains various configuration settings.&lt;/li>
&lt;li>The &lt;code>orgs&lt;/code> directory contains data from various orgs.&lt;/li>
&lt;/ol>
&lt;p>Velociraptor will automatically re-enroll clients with the same client
id (The client id is set by the client itself) as needed.&lt;/p>
&lt;p>You can also check the backups directory to recover from backup.&lt;/p>
&lt;h2 id="management-of-old-collections">Management of old collections&lt;/h2>
&lt;p>You can automatically delete old collections using the
&lt;a href="https://docs.velociraptor.app/artifact_references/pages/server.utils.deletemanyflows/" >Server.Utils.DeleteManyFlows
&lt;/a>
 and
&lt;a href="https://docs.velociraptor.app/artifact_references/pages/server.utils.deletemonitoringdata/" >Server.Utils.DeleteMonitoringData
&lt;/a>

artifacts. These are server artifacts which can delete flows and
monitoring data older than the specified time.&lt;/p></description></item><item><title>What to do about error "Plugin info not found"</title><link>https://docs.velociraptor.app/knowledge_base/tips/plugin_not_found/</link><pubDate>Fri, 05 May 2023 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/plugin_not_found/</guid><description>&lt;h1 id="what-to-do-about-error-plugin-info-not-found">What to do about error &amp;ldquo;Plugin info not found&amp;rdquo;&lt;/h1>
&lt;p>Velociraptor VQL queries can run on the server in the context of
server artifacts or notebook queries. Usually server side VQL is used
to post-process collected results, manage the server configuration,
schedule new collections etc.&lt;/p>
&lt;p>However, server side VQL can do a lot more than that - including shell
out to external binaries, read and write files on the server or
connect to external servers. In some deployments (especially shared
deployments) it is desirable to block any functionality on the server
which may interfere with other users or server security or
configuration.&lt;/p>
&lt;p>In recent Velociraptor versions the administrator can add an allow
list to the configuration file. This forces server side VQL to only
register plugins on the allow list, so potentially dangerous plugins
are not present at all (regardless of the Velociraptor permission
model).&lt;/p>
&lt;p>The configuration wizard will offer this functionality using the
question:&lt;/p>
&lt;pre>&lt;code>Do you want to restrict VQL functionality on the server?

This is useful for a shared server where users are not fully trusted.
It removes potentially dangerous plugins like execve(),filesystem access etc.
&lt;/code>&lt;/pre>
&lt;p>If you selected this during configuration you will receive these
errors in the notebook (or using the API) for any plugins not in the
allow list:&lt;/p>
&lt;pre>&lt;code>ERROR:Plugin info not found.
&lt;/code>&lt;/pre>
&lt;p>If you decide you need this particular plugin you can either add to
the allow list in the server configuration file. Or you may remove the
allow list entirely (which allows all plugins to be registered).&lt;/p></description></item><item><title>How can I automate the creation of the offline collector?</title><link>https://docs.velociraptor.app/knowledge_base/tips/automate_offline_collector/</link><pubDate>Mon, 10 Oct 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/automate_offline_collector/</guid><description>&lt;h1 id="how-can-i-automate-the-creation-of-the-offline-collector">How can I automate the creation of the offline collector?&lt;/h1>
&lt;p>The Velociraptor Offline collector is a &lt;a href="https://docs.velociraptor.app/docs/offline_triage/#offline-collections" >pre-configured triage and
acquisition tool&lt;/a>
.&lt;/p>
&lt;p>Velociraptor features a convenient GUI to allow creating the offline
collector&amp;rsquo;s including building the configuration file and embedding it
inside the collector.&lt;/p>
&lt;p>But what if we need to automate the creation of the collector? While a
GUI is nice it can be made much more efficient to automate the
collector.&lt;/p>
&lt;p>When building the collector using the GUI you might notice that the
GUI simply preconfigured and launches a new server artifact and the
server simply collects that.&lt;/p>
&lt;p>





&lt;figure id="c15c9b133f0428fb04c02bbfa4983bb9">
 &lt;div data-featherlight="#c15c9b133f0428fb04c02bbfa4983bb9" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/automate_offline_collector/create_collector.png" alt="The Create Offline Collector artifact">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="create_collector.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 The Create Offline Collector artifact
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>You can actually collect the same artifact using the command line (on
the server) or using the API (from anywhere). Here is an example with
PowerShell (assuming the server is running on Windows):&lt;/p>
&lt;pre>&lt;code class="language-powershell">velociraptor.exe --config server.config.yaml -v artifacts collect
 Server.Utils.CreateCollector
 --args OS=Windows
 --args artifacts='[&amp;quot;&amp;quot;&amp;quot;Generic.System.Pstree&amp;quot;&amp;quot;&amp;quot;]'
 --args parameters='{&amp;quot;&amp;quot;&amp;quot;Generic.System.Pstree&amp;quot;&amp;quot;&amp;quot;:{}}'
 --args target=ZIP
 --args opt_admin=N
 --args opt_prompt=N
 --output collector.zip
&lt;/code>&lt;/pre>
&lt;p>This command will create a new offline collector binary and store it
inside the file &lt;code>collector.zip&lt;/code>&lt;/p>
&lt;p>We can now extract the executable from the ZIP file (using powershell)&lt;/p>

&lt;div class="mynotices note">
 &lt;div heading=" Escaping quotes ">&lt;p>Note that running this in powershell requires quotes to be escaped in
the powershell specific way. Usually it means expanding double quotes
(&lt;code>&amp;quot;&lt;/code>) into 3 double quotes (&lt;code>&amp;quot;&amp;quot;&amp;quot;&lt;/code>)&lt;/p>
&lt;p>&lt;a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_quoting_rules" target="_blank" >https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_quoting_rules&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>


&lt;h2 id="a-collector-creation-script">A collector creation script&lt;/h2>
&lt;p>There is a simple script that makes it easier to create the collector without a GUI here
&lt;a href="https://github.com/Velocidex/velociraptor/tree/master/docs/offline_collector" target="_blank" >https://github.com/Velocidex/velociraptor/tree/master/docs/offline_collector&lt;/a>
&lt;/p>
&lt;p>This script uses a specification file to avoid the need to escaping on
the command line. The specification file is simply the same as what
will be generated by the GUI (So you can check the output of the GUI
for the ultimate reference what each variable means).&lt;/p>
&lt;p>To run the script simply create a new directory and point the script
to the Velociraptor binary for your platform and the spec file.&lt;/p>
&lt;p>The script will create a small Velociraptor deployment in the current
directory and automatically download any third party tools needed.&lt;/p>
&lt;p>The script should work with earlier versions but was tested for
Release 0.7.0 onwards.&lt;/p></description></item><item><title>How do I get the latest release binary?</title><link>https://docs.velociraptor.app/knowledge_base/tips/getting_latest_release/</link><pubDate>Sat, 03 Sep 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/getting_latest_release/</guid><description>&lt;h1 id="how-do-i-get-the-latest-release-binary">How do I get the latest release binary?&lt;/h1>
&lt;p>The Velociraptor release process uses a release branch to prepare a
new release. Releases go through a release candidate (RC) process with
one or more release builds. Sometimes after the release a new patch
release is made to backport critical bug fixes.&lt;/p>
&lt;p>If you need to automate downloading of the latest release binary,
simply use the GitHub API which presents detailed release information
in JSON form. You can use a tool such as &lt;code>jq&lt;/code> to extract the download
URL:&lt;/p>
&lt;pre>&lt;code class="language-bash">WINDOWS_URL=$(curl -s https://api.github.com/repos/velocidex/velociraptor/releases/latest | jq
-r '[.assets | sort_by(.created_at) | reverse | .[] | .browser_download_url | select(test(&amp;quot;windows-amd64.exe$&amp;quot;))][0]')
LINUX_URL=$(curl -s https://api.github.com/repos/velocidex/velociraptor/releases/latest | jq
-r '[.assets | sort_by(.created_at) | reverse | .[] | .browser_download_url | select(test(&amp;quot;linux-amd64$&amp;quot;))][0]')
MACOS_URL=$(curl -s https://api.github.com/repos/velocidex/velociraptor/releases/latest | jq
-r '[.assets | sort_by(.created_at) | reverse | .[] | .browser_download_url | select(test(&amp;quot;darwin-amd64$&amp;quot;))][0]')
&lt;/code>&lt;/pre>
&lt;p>The above &lt;code>jq&lt;/code> filter sorts all asserts by creation data and filters
the relevant binaries, then extracts the most recent binary.&lt;/p>
&lt;p>Powershell can also be used to download the latest binary for 64 bit Windows as per this example:&lt;/p>
&lt;pre>&lt;code class="language-PowerShell">#Get the latest entry from the GitHub API
$VeloLatest = Invoke-WebRequest https://api.github.com/repos/velocidex/velociraptor/releases/latest
#Parse out the url to the binary
$VeloURL = ($VeloLatest.content | convertfrom-json).assets.browser_download_url | select-string windows-amd64.exe | select-object -First 1
#Download and write to a file
Invoke-WebRequest -Uri $VeloURL.tostring() -OutFile velociraptor.exe
#Verify the Authenticode Signature
Get-AuthenticodeSignature .\velociraptor.exe
&lt;/code>&lt;/pre>
&lt;h2 id="verifying-signatures">Verifying signatures&lt;/h2>
&lt;p>Velociraptor releases are signed using Authenticode on Windows as well
as using GPG. To verify the signatures using gpg:&lt;/p>
&lt;pre>&lt;code>$ gpg --verify velociraptor-v0.6.5-2-linux-amd64.sig
gpg: assuming signed data in 'velociraptor-v0.6.5-2-linux-amd64'
gpg: Signature made Wed Jul 27 02:49:33 2022 AEST
gpg: using RSA key 0572F28B4EF19A043F4CBBE0B22A7FB19CB6CFA1
gpg: Good signature from &amp;quot;Velociraptor Team (Velociraptor - Dig deeper! https://docs.velociraptor.app/) &amp;lt;support@velocidex.com&amp;gt;&amp;quot; [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg: There is no indication that the signature belongs to the owner.
Primary key fingerprint: 0572 F28B 4EF1 9A04 3F4C BBE0 B22A 7FB1 9CB6 CFA1
&lt;/code>&lt;/pre>
&lt;p>You may need to import the key first into your keyring:&lt;/p>
&lt;pre>&lt;code>$ gpg --receive-keys 0572F28B4EF19A043F4CBBE0B22A7FB19CB6CFA1
gpg: key B22A7FB19CB6CFA1: public key &amp;quot;Velociraptor Team (Velociraptor - Dig deeper! https://docs.velociraptor.app/) &amp;lt;support@velocidex.com&amp;gt;&amp;quot; imported
gpg: Total number processed: 1
gpg: imported: 1
&lt;/code>&lt;/pre>

&lt;div class="mynotices warning">
 &lt;div heading=" API limiting ">&lt;p>GitHub limits how many unauthenticated API requests are allowed per IP
address. If you need to increase this limit, create a personal access
token (see
&lt;a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" >https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token&lt;/a>
)&lt;/p>
&lt;/div>
&lt;/div>

</description></item><item><title>How can I override the configuration file?</title><link>https://docs.velociraptor.app/knowledge_base/tips/merging_config/</link><pubDate>Tue, 26 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/merging_config/</guid><description>&lt;h1 id="how-can-i-override-the-configuration-file">How can I override the configuration file?&lt;/h1>
&lt;p>Velociraptor relies on the configuration file to control the operation
of the server or client. Usually the configuration file is generated
interactively using the &lt;code>velociraptor config generate -i&lt;/code> command.&lt;/p>
&lt;p>Many people want to automate the configuration generation or override
the configuration in some way. This short tip covers some of the
common ways to do that.&lt;/p>
&lt;h2 id="automating-configuration-generation">Automating configuration generation.&lt;/h2>
&lt;p>When generating a new configuration, Velociraptor will generate new
key material and create a reasonable skeleton for the supported
deployment scenario. In the following command, Velociraptor will emit
a basic configuration file template to standard output, which can be
easily redirected to a file:&lt;/p>
&lt;pre>&lt;code>$ velociraptor-v0.6.4-linux-amd64 config generate &amp;gt; /tmp/config.yaml
&lt;/code>&lt;/pre>
&lt;p>To customize the generated configuration we can apply a JSON
merge/patch step. &lt;a href="https://datatracker.ietf.org/doc/html/rfc7396" target="_blank" >JSON
merge&lt;/a>
 and &lt;a href="http://jsonpatch.com/" target="_blank" >JSON
patch&lt;/a>
 are standard ways of specifying a
transformation on a JSON object.&lt;/p>

&lt;div class="mynotices tip">
 &lt;div heading="tip">&lt;p>Normally the configuration file is in YAML but you can also view it in
JSON using the &lt;code>--json&lt;/code> flag to the &lt;code>config show&lt;/code> command:&lt;/p>
&lt;pre>&lt;code>velociraptor --config config.yaml config show --json
&lt;/code>&lt;/pre>
&lt;p>Since YAML is a superset of JSON you can also provide this JSON blob
to Velociraptor as the actual configuration (no need to convert it
back to YAML). This helps to prepare the JSON merge patch - simply
remove the fields you dont want to change and change the fields you do
want to change.&lt;/p>
&lt;/div>
&lt;/div>


&lt;p>For example, imagine we want to specify a new URL for clients to
connect to. We can merge the following JSON blob with the config:&lt;/p>
&lt;pre>&lt;code>$ velociraptor --config /tmp/config.yaml config show --merge '{&amp;quot;Client&amp;quot;:{&amp;quot;server_urls&amp;quot;:[&amp;quot;https://192.168.1.11:8000/&amp;quot;, &amp;quot;https://192.168.1.12:8000/&amp;quot;]}}' &amp;gt; /tmp/new_config.yaml
&lt;/code>&lt;/pre>
&lt;p>It may be more convenient to store the JSON merge blob in a file
instead of specifying on the command line - use the &lt;code>--merge_file&lt;/code>
option to provide it.&lt;/p>
&lt;h2 id="overriding-configuration-at-runtime">Overriding configuration at runtime&lt;/h2>
&lt;p>While the &lt;code>config show&lt;/code> command can be used to manipulate the
configuration file, sometimes we want to change a few values at
runtime on a temporary basis.&lt;/p>
&lt;p>The first option is using the &lt;code>--config_override&lt;/code> flag to specify the
path to a JSON merge file that overrides the configuration at
runtime. Velociraptor will load the configuration file specified by
the &lt;code>--config&lt;/code> flag as normal, but then will apply the JSON merge blob
to override specific fields.&lt;/p>
&lt;p>This is useful for specifying a larger configuration manipulation - it
will not change the main config file at all, but will change the
running configuration&lt;/p>
&lt;h2 id="overriding-configuration-via-command-line-flags">Overriding configuration via command line flags&lt;/h2>
&lt;p>Velociraptor allows most configuration settings to be overriden by
suitable command line flags. Since there are so many flags, the usual
help shown with the &lt;code>--help&lt;/code> flag does not include these configuration
overriding flags.&lt;/p>
&lt;p>You can see all the defined flags by enabling the DEBUG environment
variable:&lt;/p>
&lt;pre>&lt;code>$ DEBUG=1 ./velociraptor --help

...
 --config.client-writeback-darwin=CONFIG.CLIENT-WRITEBACK-DARWIN
 --config.client-writeback-linux=CONFIG.CLIENT-WRITEBACK-LINUX
 --config.client-writeback-windows=CONFIG.CLIENT-WRITEBACK-WINDOWS
 --config.client-tempdir-linux=CONFIG.CLIENT-TEMPDIR-LINUX
 --config.client-tempdir-windows=CONFIG.CLIENT-TEMPDIR-WINDOWS
&lt;/code>&lt;/pre>
&lt;p>This is useful to override specific settings temporarily - for example
when running the server in a cloud environment, the bind port is
determined by the platform. In this case it is easier to simply
override this on the command line rather than manipulate the config
file.&lt;/p>
&lt;pre>&lt;code>velociraptor --config /etc/velociraptor/server.config.yaml frontend --config.frontend-bind-port=$PORT
&lt;/code>&lt;/pre></description></item><item><title>How can I save my favorite collections for the future?</title><link>https://docs.velociraptor.app/knowledge_base/tips/favorites/</link><pubDate>Tue, 26 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/favorites/</guid><description>&lt;h1 id="how-can-i-save-my-favorite-collections-for-the-future">How can I save my favorite collections for the future?&lt;/h1>
&lt;p>Sometimes we tend to collect the same set of artifacts together,
possibly with some specific parameters. It gets tedious to constantly
reconfigure the &lt;code>New Collection&lt;/code> interface with the same set of
artifacts.&lt;/p>
&lt;p>This where the &lt;code>favorites&lt;/code> feature comes in. We can save existing
collections including the artifacts collected and their
parameters. Then in future we just need to restore our collections
from our favorites.&lt;/p>
&lt;p>





&lt;figure id="40df04caa5af69c051a81f33ff2e565a">
 &lt;div data-featherlight="#40df04caa5af69c051a81f33ff2e565a" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/favorites/fav.png" alt="Saving a collection as a favorite">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="fav.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Saving a collection as a favorite
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;p>The favorite can be restored in future by simply adding a new
collection, clicking the favorite button and searching for it.&lt;/p>
&lt;p>





&lt;figure id="43befe2b5c6796c74b67fdaa3b5bbdf6">
 &lt;div data-featherlight="#43befe2b5c6796c74b67fdaa3b5bbdf6" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/favorites/fav2.png" alt="Restoring a favorite collection">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="fav2.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Restoring a favorite collection
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;h2 id="creating-favorites-programmatically">Creating favorites programmatically&lt;/h2>
&lt;p>Favorites are stored into the user&amp;rsquo;s profile, since each user might
have a different set of artifacts they normally use.&lt;/p>
&lt;p>It is possible however to create favorites using VQL with the &lt;a href="https://docs.velociraptor.app/vql_reference/server/favorites_save/" >favorites_save()&lt;/a>
 function:&lt;/p>
&lt;pre>&lt;code class="language-vql">SELECT favorites_save(type=&amp;quot;CLIENT&amp;quot;, name=&amp;quot;MyFavorite&amp;quot;,
specs='''
[{&amp;quot;artifact&amp;quot;:&amp;quot;Windows.Search.FileFinder&amp;quot;,
 &amp;quot;parameters&amp;quot;: {
 &amp;quot;env&amp;quot;: [{
 &amp;quot;key&amp;quot;: &amp;quot;SearchFilesGlob&amp;quot;,
 &amp;quot;value&amp;quot;: &amp;quot;HKEY_USERS/*/Software/Sysinternals/*/*&amp;quot;
 }, {
 &amp;quot;key&amp;quot;: &amp;quot;Accessor&amp;quot;,
 &amp;quot;value&amp;quot;: &amp;quot;registry&amp;quot;
 }]}}]''')
FROM scope()
&lt;/code>&lt;/pre>
&lt;p>Note the &lt;code>spec&lt;/code> parameter is a JSON encoded blob of the various
artifact parameters.&lt;/p>
&lt;p>By including the VQL in a notebook, any user can collect it and
install the favorites in their own profile.&lt;/p></description></item><item><title>How to fix "certificate has expired or not yet valid error"?</title><link>https://docs.velociraptor.app/knowledge_base/tips/rolling_certificates/</link><pubDate>Tue, 26 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/rolling_certificates/</guid><description>&lt;h1 id="how-to-fix-certificate-has-expired-or-not-yet-valid-error">How to fix &amp;ldquo;certificate has expired or not yet valid error&amp;rdquo;?&lt;/h1>
&lt;p>When Velociraptor generates a configuration file it also generates
some certificates to secure it&amp;rsquo;s internal PKI.&lt;/p>
&lt;p>The CA certificate is embedded in the client&amp;rsquo;s configuration file and
underpins the entire Velociraptor communications protocol - all
certificates are issued by this internal CA. The Velociraptor CA is
set to expire in 10 years.&lt;/p>
&lt;p>The Server certificate is signed by the CA certificate and is set to
expire in 1 year by default. When the certificate expires, clients
will be unable to connect to the server any more.&lt;/p>
&lt;p>You can check the expiry time of the server certificate using curl and
openssl:&lt;/p>
&lt;pre>&lt;code>$ curl -s -k https://127.0.0.1:8000/server.pem | openssl x509 -text | grep -A 2 Validity
Validity
 Not Before: Apr 13 12:05:46 2022 GMT
 Not After : Apr 13 12:05:46 2023 GMT
&lt;/code>&lt;/pre>
&lt;h2 id="what-happens-when-the-certificate-expires">What happens when the certificate expires?&lt;/h2>
&lt;ul>
&lt;li>When the internal server certificate expires clients will not accept it and
they will refuse to communicate. Clients will show as offline in the GUI and
buffer data as long as possible, subject to their configured buffer limits.&lt;/li>
&lt;li>New GUI sessions will fail with &amp;ldquo;500 Internal Server Error&amp;rdquo; and the response
body &lt;code>{&amp;quot;code&amp;quot;:2,&amp;quot;message&amp;quot;:&amp;quot;Must set a username&amp;quot;}&lt;/code> and fail to load.&lt;/li>
&lt;/ul>
&lt;p>For Velociraptor versions 0.74 and later there is a mechanism to mitigate the
impact of unexpected certificate expiry:&lt;/p>
&lt;ul>
&lt;li>Upon restarting the server service, if the certificate
(&lt;code>Frontend.certificate&lt;/code>) has expired, and if the server.config.yaml contains
the CA private key then it will automatically issue a new cert with the same
validity period as the expired one. This temporary certificate is held in
memory only and is NOT written to the server.config.yaml.&lt;/li>
&lt;li>In the server log you will see the following messages:&lt;/li>
&lt;/ul>
&lt;pre>&lt;code class="language-bash">[ERROR] &amp;lt;log_date&amp;gt; Frontend Certificate is not valid: Certificate Valid NotBefore &amp;lt;start_date&amp;gt; and Not After &amp;lt;end_date&amp;gt; but Now is &amp;lt;current_date&amp;gt;. See https://docs.velociraptor.app/knowledge_base/tips/rolling_certificates/
[INFO] &amp;lt;log_date&amp;gt; Found CA private key in config, will automatically rotate keys, but you should consider updating the config file using `velociraptor config rotate`
&lt;/code>&lt;/pre>
&lt;p>If this is the case you should update your server certificate by reissuing a new
one.&lt;/p>
&lt;h2 id="rotating-certificates">Rotating certificates&lt;/h2>
&lt;p>Reissuing a new server certificate can be performed at any time using the
&lt;code>config reissue_certs&lt;/code> command. You can even reissue a certificate with extended
validity before you deploy your server.&lt;/p>
&lt;p>The procedure amounts to generating a new server configuration which is derived
from the old one, and then replacing the old config with the new config.&lt;/p>
&lt;p>The &lt;code>config rotate_keys&lt;/code> command can be used to regenerate both the server
certificate and the associated private key. Although this is not necessary for
operational purposes, it is considered good security practice to rotate keys and
certificates periodically, and particularly after a suspected systems
compromise.&lt;/p>

&lt;div class="mynotices info">
 &lt;div heading="info">&lt;p>For server versions older than 0.72.3 please use the following commands instead
of those shown below:&lt;/p>
&lt;table>
 &lt;thead>
 &lt;tr>
 &lt;th style="text-align: center">Goal&lt;/th>
 &lt;th>Command for the current version&lt;/th>
 &lt;th>Command for versions &amp;lt;0.72.3&lt;/th>
 &lt;/tr>
 &lt;/thead>
 &lt;tbody>
 &lt;tr>
 &lt;td style="text-align: center">Reissue only the server cert&lt;/td>
 &lt;td>&lt;code>velociraptor config reissue_certs&lt;/code>&lt;/td>
 &lt;td>&lt;code>velociraptor config reissue_key&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td style="text-align: center">Reissue the server cert and&lt;br> also the private key&lt;/td>
 &lt;td>&lt;code>velociraptor config rotate_keys&lt;/code>&lt;/td>
 &lt;td>&lt;code>velociraptor config rotate_key&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;/tbody>
&lt;/table>
&lt;/div>
&lt;/div>


&lt;h4 id="setting-a-non-standard-validity">Setting a non-standard validity&lt;/h4>
&lt;p>When reissuing the certificate the &lt;code>--validity&lt;/code> flag can be used to extend the
validity beyond the default of one year. For example, to generate a config
containing a server certificate which is valid for 2 years, you would run the
command:&lt;/p>
&lt;pre>&lt;code class="language-sh">velociraptor --config server.config.yaml config reissue_certs --validity 730 &amp;gt; new.server.config.yaml
&lt;/code>&lt;/pre>
&lt;p>If you expect your server to be a long-term instance then you don&amp;rsquo;t have to
start with the default 1-year validity and wait for the certificate to expire.
You can generate a new config on day 1 based on the initial config using the
&lt;code>config reissue_certs&lt;/code> command. You can then use the new config for the new
server installation.&lt;/p>

&lt;div class="mynotices tip">
 &lt;div heading="tip">&lt;p>In version 0.74 and later the configuration wizard (&lt;code>velociraptor config generate -i&lt;/code>) allows you to issue the server certificate with either 1-year,
2-year or 10-year validity.&lt;/p>
&lt;/div>
&lt;/div>


&lt;h4 id="option-1-reissue-only-the-server-cert">Option 1: Reissue only the server cert&lt;/h4>
&lt;p>To rotate server certificates, use the following command to generate a new
configuration file containing rotated certificates:&lt;/p>
&lt;pre>&lt;code>$ velociraptor config reissue_certs --config /etc/velociraptor/server.config.yaml &amp;gt; /tmp/new_key.config.yaml
&lt;/code>&lt;/pre>
&lt;p>The &lt;code>config reissue_key&lt;/code> command updates the following configuration items:&lt;/p>
&lt;ul>
&lt;li>&lt;code>GUI.gw_certificate&lt;/code>&lt;/li>
&lt;li>&lt;code>Frontend.certificate&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>CA.private_key&lt;/code>, &lt;code>Client.ca_certificate&lt;/code>, &lt;code>GUI.gw_private_key&lt;/code>, and &lt;code>Frontend.private_key&lt;/code> are preserved.&lt;/p>
&lt;h4 id="option-2-reissue-the-server-cert-and-also-the-private-key">Option 2: Reissue the server cert and also the private key&lt;/h4>
&lt;p>Alternatively, you can regenerate the server&amp;rsquo;s private keys and rotate the
certificates at the same time:&lt;/p>
&lt;pre>&lt;code>$ velociraptor config rotate_keys --config /etc/velociraptor/server.config.yaml &amp;gt; /tmp/new_key.config.yaml
&lt;/code>&lt;/pre>
&lt;p>The &lt;code>config rotate_key&lt;/code> command updates the following configuration items:&lt;/p>
&lt;ul>
&lt;li>&lt;code>GUI.gw_certificate&lt;/code>&lt;/li>
&lt;li>&lt;code>GUI.gw_private_key&lt;/code>&lt;/li>
&lt;li>&lt;code>Frontend.certificate&lt;/code>&lt;/li>
&lt;li>&lt;code>Frontend.private_key&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>CA.private_key&lt;/code> and &lt;code>Client.ca_certificate&lt;/code> are preserved.&lt;/p>
&lt;p>The previous two commands will not affect the CA private key and
certificate, which is valid for 10 years, as described previously.&lt;/p>
&lt;p>You can view the new certificate using jq and openssl (here &lt;code>jq&lt;/code> is
used to show the PEM certificate of the frontend and &lt;code>openssl&lt;/code> is used
to decode it)&lt;/p>
&lt;pre>&lt;code>$ velociraptor --config /tmp/new_key.config.yaml config show --json | jq -r .Frontend.certificate | openssl x509 -text | grep -A 2 Validity
Validity
 Not Before: Apr 25 21:01:51 2022 GMT
 Not After : Apr 25 21:01:51 2023 GMT
&lt;/code>&lt;/pre>
&lt;p>Now back up the old configuration file and replace it with the new
file, then restart the server. Clients should reconnect automatically.&lt;/p></description></item><item><title>What is the easiest way to have Velociraptor start with a custom server artifact automatically loaded?</title><link>https://docs.velociraptor.app/knowledge_base/tips/startup_artifacts/</link><pubDate>Tue, 26 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/startup_artifacts/</guid><description>&lt;h1 id="what-is-the-easiest-way-to-have-velociraptor-start-with-a-custom-server-artifact-automatically-loaded">What is the easiest way to have Velociraptor start with a custom server artifact automatically loaded?&lt;/h1>
&lt;p>Velociraptor frontend process has a component called the &lt;code>Artifact Repository&lt;/code>. This component knows about all the artifacts that are
defined. When the server starts up, it loads artifacts into the
repository from the following sources.&lt;/p>
&lt;ol>
&lt;li>Built in artifacts are embedded into the binary itself.&lt;/li>
&lt;li>It is possible to provide custom artifacts inside the configuration
file itself.&lt;/li>
&lt;li>Providing a directory with the &lt;code>--definitions&lt;/code> flag will cause
Velociraptor to scan the directory for artifact YAML files.&lt;/li>
&lt;li>Finally, the server will load artifacts from the configured
filestore path under &lt;code>&amp;lt;filestore&amp;gt;/artifact_definitions&lt;/code>. These are
usually the custom artifacts defined through the GUI.&lt;/li>
&lt;/ol>
&lt;p>The location of where an artifact came from does not matter,
Velociraptor organizes artifacts internally using the artifact
name. It is customary to denote custom artifacts with the &lt;code>Custom.&lt;/code>
prefix but this is not mandatory.&lt;/p>

&lt;div class="mynotices warning">
 &lt;div heading="warning">&lt;p>Velociraptor does not allow a custom artifact to override a built in
artifact (i.e. have the same name). Built in artifacts are protected
because overriding built in artifacts may break the proper
functionality of Velociraptor. If you want to customize a built in
artifact, simply change the name when you save it.&lt;/p>
&lt;p>Velociraptor considers artifacts defined in the config file, or given
in the &lt;code>--definitions&lt;/code> directory as &amp;ldquo;built in&amp;rdquo;.&lt;/p>
&lt;/div>
&lt;/div>


&lt;h2 id="specifying-a-startup-artifact">Specifying a startup artifact.&lt;/h2>
&lt;p>When the Velociraptor server is run for the very first time, it
creates an install record in the filestore
&lt;code>&amp;lt;filestore&amp;gt;/config/install_time.json.db&lt;/code>. It can then setup initial
artifacts to collect as specified by the config file:&lt;/p>
&lt;pre>&lt;code class="language-yaml">Frontend:
 default_client_monitoring_artifacts:
 - Generic.Client.Stats
 initial_server_artifacts:
 - MyServerArtifact
 default_server_monitoring_artifacts:
 - MyCustomServerMonitor
&lt;/code>&lt;/pre>
&lt;p>In the above snippet, we see the following parameters:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>default_client_monitoring_artifacts&lt;/code> specifies the initial client
monitoring table that will be created. By default, Velociraptor
collects endpoint CPU and Memory telemetry from all endpoints. You
can remove this, or specify a different client artifact to collect.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>default_server_monitoring_artifacts&lt;/code> specifies an initial set of
server event artifacts to collect.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>initial_server_artifacts&lt;/code> is a list of server artifacts that will
be automatically launched on the server on initial startup. You can
specify the names of any artifacts here (including custom artifacts)
which can be bootstrapped to perform any kinds of server
configuration needed. The artifacts are simply scheduled and will
appear in the usual &lt;code>Server Artifacts&lt;/code> screen.&lt;/p>
&lt;/li>
&lt;/ul>

&lt;div class="mynotices note">
 &lt;div heading="note">&lt;p>Currently it is not possible to specify parameters for initial
artifacts so if you need to tweak the parameters it is best to create
a custom artifact that in turn launches the needed artifacts with the
correct parameters.&lt;/p>
&lt;/div>
&lt;/div>

</description></item><item><title>How do I use my own SSL certificates?</title><link>https://docs.velociraptor.app/knowledge_base/tips/ssl/</link><pubDate>Mon, 18 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/ssl/</guid><description>&lt;h1 id="how-do-i-use-my-own-ssl-certificates">How do I use my own SSL certificates?&lt;/h1>
&lt;p>Use case: For an on-premises deployment, Let&amp;rsquo;s Encrypt may not be an option. You may want to use your own enterprise/corporate Certificate Authority (CA) or another 3rd party.&lt;/p>
&lt;p>Thanks to recent enhancements by the Velociraptor developers, this is quite a simple task. The below is a simple test configuration used and may need adapting to your environment.&lt;/p>
&lt;p>Prior to commencing we have a plaintext PEM private key, certificate for our Velociraptor server, and the certificate chain of our enterprise CA, including the root and multiple intermediaries.&lt;/p>
&lt;h3 id="generate-the-configuration">Generate the configuration&lt;/h3>
&lt;p>Using Ubuntu we generated a stock standard &amp;ldquo;Self Signed SSL&amp;rdquo; configuration:&lt;/p>
&lt;p>&lt;code>./velociraptor-v0.6.3-2-linux-amd64 config generate -i&lt;/code>&lt;/p>
&lt;img width="491" alt="image" src="https://user-images.githubusercontent.com/30587915/163787136-f9e6f16f-5119-4cd0-ba43-741ab64cdc42.png">
&lt;h3 id="update-the-serverconfigyaml">Update the server.config.yaml&lt;/h3>
&lt;p>Locate the frontend section and add the &lt;code>tls_certificate_filename&lt;/code> and &lt;code>tls_private_key_filename&lt;/code> parameters. Enter the absolute path to these files. For testing, we placed in /etc however there is better places for production use.&lt;/p>
&lt;pre>&lt;code class="language-yaml">Frontend:
 tls_certificate_filename: /etc/velociraptor.pem
 tls_private_key_filename: /etc/velociraptor.key
&lt;/code>&lt;/pre>
&lt;img width="221" alt="image" src="https://user-images.githubusercontent.com/30587915/163787153-9734cbb8-ddbf-4140-b4d6-1c89e19afa7c.png">
&lt;h3 id="update-the-clientconfigyaml">Update the client.config.yaml&lt;/h3>
&lt;p>In the client section modify &lt;code>use_self_signed_ssl&lt;/code> to be false, and add the CA root/intermediary certificates to be trusted by the client:&lt;/p>
&lt;pre>&lt;code class="language-yaml">use_self_signed_ssl: false

Crypto:
 root_certs: |
 -----BEGIN CERTIFICATE-----
 XXXXX
 -----END CERTIFICATE-----
 -----BEGIN CERTIFICATE-----
 XXXXX
 -----END CERTIFICATE-----
 -----BEGIN CERTIFICATE-----
 XXXXX
 -----END CERTIFICATE-----
 ...
&lt;/code>&lt;/pre>
&lt;h3 id="test">Test&lt;/h3>
&lt;p>Launching the server we should be able to connect to the GUI using our new certificate. Note this must be trusted by browser/system to prevent errors.&lt;/p>
&lt;p>Launching the client, it should connect securely without error, using the trusted CA chain and the new server certificate.&lt;/p>
&lt;p>No changes need to be made to the pinned certificate name, nor do any certificates need to be modified in the configuration files.&lt;/p></description></item><item><title>How do I set a proxy for client communications?</title><link>https://docs.velociraptor.app/knowledge_base/tips/proxy/</link><pubDate>Fri, 15 Apr 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/proxy/</guid><description>&lt;h1 id="how-do-i-set-a-proxy-for-client-communications">How do I set a proxy for client communications?&lt;/h1>
&lt;p>Many enterprise environments require a proxy to be set before outbound
web communications is allowed. The Velociraptor client uses HTTP to
communicate with the server, and therefore must use a proxy to
connect in such environments.&lt;/p>
&lt;p>It is possible to specify the HTTP proxy using the configuration file
or environment variables.&lt;/p>
&lt;h3 id="environment-variables">Environment variables.&lt;/h3>
&lt;p>Environment variables may be configured using group policy or similar
methods. Setting the &lt;code>http_proxy&lt;/code> and &lt;code>https_proxy&lt;/code> environment
variables will force the client to go through the specified proxy.&lt;/p>
&lt;p>The rules for environment variables are described
&lt;a href="https://go.dev/src/net/http/transport.go#422" target="_blank" >here&lt;/a>
:&lt;/p>
&lt;pre>&lt;code class="language-go">// ProxyFromEnvironment returns the URL of the proxy to use for a
// given request, as indicated by the environment variables
// HTTP_PROXY, HTTPS_PROXY and NO_PROXY (or the lowercase versions
// thereof). HTTPS_PROXY takes precedence over HTTP_PROXY for https
// requests.
//
// The environment values may be either a complete URL or a
// &amp;quot;host[:port]&amp;quot;, in which case the &amp;quot;http&amp;quot; scheme is assumed.
// The schemes &amp;quot;http&amp;quot;, &amp;quot;https&amp;quot;, and &amp;quot;socks5&amp;quot; are supported.
// An error is returned if the value is a different form.
&lt;/code>&lt;/pre>
&lt;h3 id="setting-a-proxy-in-the-configuration-file">Setting a proxy in the configuration file&lt;/h3>
&lt;p>You can also hard code the proxy in the configuration file&amp;rsquo;s Client
section:&lt;/p>
&lt;pre>&lt;code class="language-yaml">Client:
 proxy: http://proxy.example.com:3128/
 server_urls:
 - https://velo.example.com:8100/
&lt;/code>&lt;/pre></description></item><item><title>How to increase notebook timeout</title><link>https://docs.velociraptor.app/knowledge_base/tips/notebook_timeout/</link><pubDate>Tue, 29 Mar 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/notebook_timeout/</guid><description>&lt;h1 id="how-to-increase-notebook-timeout">How to increase notebook timeout&lt;/h1>
&lt;p>In the notebook, VQL queries are limited to 10 minutes. Once the timeout is expired, the query is cancelled.
Regular collections from clients also have a timeout, that timeout can be changed in the new collection wizard GUI to give the query more time.&lt;/p>
&lt;p>But there is no similar control for the notebook cells. In the notebook, the time limit serves to limit server load - because the notebook queries are run on the server we don&amp;rsquo;t want them to take too long or make it too easy to extend the timeout too long.&lt;/p>
&lt;p>If you find that your cell query is routinely exceeding the timeout, you can use one of the following approaches:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Make the query more efficient - for example using multi-threaded queries or the &lt;code>parallelize()&lt;/code> plugin.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Turn the query into a server artifact. Large queries are often very reusable and if you can turn it into an artifact, it might be useful again. Running a server artifact allows the timeout to be increased if needed.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>As a last resort update the default notebook timeout in the configuration file. Find or add the section called &lt;code>defaults&lt;/code> and add the following setting:&lt;/p>
&lt;/li>
&lt;/ol>
&lt;pre>&lt;code class="language-yaml">Frontend:
... other settings ...
defaults:
 notebook_cell_timeout_min: 20
&lt;/code>&lt;/pre></description></item><item><title>How do I upgrade my server and clients?</title><link>https://docs.velociraptor.app/knowledge_base/tips/upgrading/</link><pubDate>Sun, 27 Mar 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/upgrading/</guid><description>&lt;h1 id="how-do-i-upgrade-my-server-and-clients">How do I upgrade my server and clients?&lt;/h1>
&lt;p>To upgrade the Velociraptor server to a new version, simply download the latest release binary from the GitHub Release Page and regenerate a new &lt;code>Debian&lt;/code> package as described above, but using the existing configuration file.&lt;/p>
&lt;p>See &lt;a href="https://docs.velociraptor.app/docs/deployment/cloud/#server-upgrades" >this page for more details&lt;/a>
&lt;/p>
&lt;p>To upgrade the Velociraptor clients, you will need to push out new MSIs using the existing client configuration files.&lt;/p>
&lt;p>More details on &lt;a href="https://docs.velociraptor.app/docs/deployment/clients/#client-upgrades" >Client upgrades&lt;/a>
&lt;/p>
&lt;h2 id="supported-upgrade-scenarios">Supported Upgrade Scenarios&lt;/h2>
&lt;p>Matching client and server versions is the most supported configuration.
See &lt;a href="https://docs.velociraptor.app/docs/overview/support/#client-and-server-versioning" >the support policy&lt;/a>
&lt;/p>
&lt;p>Before upgrading perform testing of the combination of client and server versions to be used, compatibility of mixed versions is best efforts based on community testing and issues being reported.&lt;/p>
&lt;ul>
&lt;li>Check &lt;a href="https://github.com/Velocidex/velociraptor/issues" target="_blank" >GitHub&lt;/a>
 for issues reported by the community.&lt;/li>
&lt;li>Read &lt;a href="https://github.com/Velocidex/velociraptor/releases" target="_blank" >release notes&lt;/a>
 for all versions between the current version, and the version you are moving to if skipping versions. Generally though avoid skipping versions.&lt;/li>
&lt;/ul>
&lt;h2 id="other-tips">Other tips&lt;/h2>
&lt;ul>
&lt;li>Recent versions of clients and servers generally can communicate with each other without a problem, but new functionality may not be available on old clients. Artifacts like &lt;a href="https://github.com/Velocidex/velociraptor/issues/1566" target="_blank" >this&lt;/a>
 will (0.6.4+) help reduce this.&lt;/li>
&lt;li>Upgrading the server before clients is more common, so version problems are more likely to have been caught in community testing with this approach.&lt;/li>
&lt;li>Consider running a parallel deployment as the most compatible way to upgrade. Such as when upgrading and there are known breaking changes between the current client and target server versions (going from self-signed to auto cert), or when there are large version differences (unusual combinations of client and server).&lt;/li>
&lt;/ul></description></item><item><title>How can I configure Velociraptor for multiple SSO providers</title><link>https://docs.velociraptor.app/knowledge_base/tips/multiple_oauth/</link><pubDate>Sat, 26 Mar 2022 00:00:00 +0000</pubDate><guid>https://docs.velociraptor.app/knowledge_base/tips/multiple_oauth/</guid><description>&lt;h1 id="how-can-i-configure-velociraptor-for-multiple-sso-providers">How can I configure Velociraptor for multiple SSO providers&lt;/h1>
&lt;p>Velociraptor can be configured to use a single SSO provider using the usual configuration building wizard (see &lt;a href="https://docs.velociraptor.app/docs/deployment/cloud/#configuring-google-oauth-sso" target="_blank" >Here&lt;/a>
), but the wizard does not offer to configure multiple providers.&lt;/p>
&lt;p>Sometimes we want to have multiple providers so we can allow users from another organization to be able to log into Velociraptor. To do this we need to configure the SSO authenticator manually in the configuration file.&lt;/p>
&lt;p>Simply run &lt;code>velociraptor config generate -i&lt;/code> and select the OAuth provider for the first provider. In the end your config file will have the following section where &lt;code>oauth_client_id&lt;/code> and &lt;code>oauth_client_secret&lt;/code> refer to the Google OAuth app you created:&lt;/p>
&lt;pre>&lt;code class="language-yaml">GUI:
 ... more settings ...
 authenticator:
 type: Google
 oauth_client_id: 12345.apps.googleusercontent.com
 oauth_client_secret: XYZ1234
&lt;/code>&lt;/pre>
&lt;p>To provide multiple authenticators, you will need to manually change to the &lt;code>multi&lt;/code> authenticator type:&lt;/p>
&lt;pre>&lt;code class="language-yaml">GUI:
 ... more settings ...
 authenticator:
 type: multi
 sub_authenticators:
 - type: Google
 oauth_client_id: 12345.apps.googleusercontent.com
 oauth_client_secret: XYZ1234
 - type: Github
 oauth_client_id: 123456
 oauth_client_secret: 76521376523
 - type: oidc
 oidc_issuer: https://accounts.google.com
 oidc_name: Rapid7
 avatar: https://example.com/avatar.png
 oauth_client_id: XXXXX
 oauth_client_secret: AAAAA
&lt;/code>&lt;/pre>
&lt;p>Note that you can have multiple &lt;code>OIDC&lt;/code> authenticators and each can have a separate name and an icon associated with it (e.g. if multiple organizations use separate Okta logins).&lt;/p>
&lt;p>





&lt;figure id="47a0513752ad43ed9f3f48bd62462858">
 &lt;div data-featherlight="#47a0513752ad43ed9f3f48bd62462858" class="figure">
 &lt;img src="https://docs.velociraptor.app/knowledge_base/tips/multiple_oauth/https://user-images.githubusercontent.com/3856546/160241517-c2bf85e5-7d5d-4d3b-ac24-b2bfbda5436b.png" alt="Logging in with multiple providers">
 &lt;/div>
 &lt;figcaption>
 &lt;a class="image-link" href="https://user-images.githubusercontent.com/3856546/160241517-c2bf85e5-7d5d-4d3b-ac24-b2bfbda5436b.png">&lt;i class="fa fa-download">&lt;/i>&lt;/a>
 Logging in with multiple providers
 &lt;/figcaption>
&lt;/figure>


&lt;/p>
&lt;h2 id="granting-a-user-a-role">Granting a user a role.&lt;/h2>
&lt;p>Velociraptor will trust any of the configured authenticators, to identify the user and based on the username, grant the user the appropriate roles on the Velociraptor server. You will need to grant the user a role either through the command line:&lt;/p>
&lt;pre>&lt;code>velociraptor user add --role administrator mike@gmail.comm
&lt;/code>&lt;/pre>
&lt;p>Or via a notebook cell:&lt;/p>
&lt;pre>&lt;code class="language-sql">SELECT user_create(user=&amp;quot;mike@gmail.com&amp;quot;, role=&amp;quot;administrator&amp;quot;)
FROM scope()
&lt;/code>&lt;/pre>

&lt;div class="mynotices warning">
 &lt;div heading=" Trusting multiple providers ">&lt;p>Be aware that trusting multiple identity providers can result in account hijack if a user can get an account of the same name on another provider. Velociraptor just uses the account name provided by the OAuth provider to grant access and does not keep track of which provider actually identified the user.&lt;/p>
&lt;p>In simple terms, if a user has username &amp;ldquo;mike&amp;rdquo; on &lt;code>OIDC&lt;/code> provider 1 and another user can get say a Github account for the user &amp;ldquo;mike&amp;rdquo;, then the second user can impersonate the first user by logging in with the second provider.&lt;/p>
&lt;/div>
&lt;/div>

</description></item></channel></rss>